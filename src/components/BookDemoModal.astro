---
/**
 * Book Demo Modal - Astro Component
 *
 * Uses starwind dialog for HubSpot form integration
 */

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle
} from "@/components/starwind/dialog";

interface Props {
  id?: string;
}

const { id = "book-demo-modal" } = Astro.props;
---

<Dialog id={id}>
  <DialogContent class="max-w-[600px] p-0" animationDuration={200}>
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-border">
      <DialogTitle class="text-lg font-medium text-foreground">
        Book a Demo
      </DialogTitle>
    </div>

    <!-- Body -->
    <div class="relative p-6" id="book-demo-modal-body">
      <!-- Loading State -->
      <div id="book-demo-loading" class="text-center py-10 px-6">
        <div class="w-12 h-12 mx-auto mb-4 border-4 border-muted border-t-primary rounded-full animate-spin"></div>
        <p class="text-muted-foreground text-sm m-0">Loading form...</p>
      </div>

      <!-- HubSpot Form Container -->
      <div id="astra-hubspot-form" class="hidden"></div>

      <!-- Fallback iframe -->
      <iframe
        id="book-demo-iframe"
        src="https://share.hsforms.com/1bdyAzMxTQ62tddJ1cshBFAfamea"
        width="100%"
        height="500"
        frameBorder="0"
        class="border-0 hidden"
        title="Book a Demo Form">
      </iframe>
    </div>
  </DialogContent>
</Dialog>

<script>
  // HubSpot Form initialization
  interface FormField {
    name: string;
    value: string;
  }

  interface FormData {
    firstname: string;
    email: string;
    phone: string;
  }

  let useIframe = false;

  // Initialize HubSpot form
  async function initializeHubSpotForm() {
    const loadingEl = document.getElementById('book-demo-loading');
    const formContainer = document.getElementById('astra-hubspot-form');
    const iframeEl = document.getElementById('book-demo-iframe');

    if (!loadingEl || !formContainer || !iframeEl) return;

    // Load HubSpot script if not loaded
    if (typeof (window as any).hbspt === 'undefined') {
      const script = document.createElement('script');
      script.src = '//js.hsforms.net/forms/embed/v2.js';
      script.async = true;
      script.charset = 'utf-8';
      script.onload = () => createForm();
      script.onerror = () => {
        console.error('Failed to load HubSpot script, falling back to iframe');
        showIframe();
      };
      document.body.appendChild(script);
    } else {
      createForm();
    }

    function createForm() {
      if (typeof (window as any).hbspt !== 'undefined' && formContainer) {
        try {
          (window as any).hbspt.forms.create({
            region: 'na1',
            portalId: '2858726',
            formId: '6dd802cc-f156-433b-ad75-27572cc84914',
            target: formContainer,
            onFormReady: () => {
              console.log('HubSpot form ready');
              loadingEl?.classList.add('hidden');
              formContainer.classList.remove('hidden');
            },
            onFormSubmit: () => {
              console.log('Form submitting...');
            },
          });
        } catch (error) {
          console.error('Error creating HubSpot form:', error);
          showIframe();
        }
      } else {
        showIframe();
      }
    }

    function showIframe() {
      useIframe = true;
      loadingEl?.classList.add('hidden');
      iframeEl.classList.remove('hidden');
    }
  }

  // Listen for form submission
  function handleFormSubmission(event: any) {
    // v4 form event
    if (event.detail?.type === 'ON_FORM_SUBMITTED') {
      extractFormData(event.detail.data);
    }
    // v2/v3 form event
    if (event.data?.type === 'hsFormCallback' && event.data?.eventName === 'onFormSubmitted') {
      extractFormData(event.data.data);
    }
  }

  function extractFormData(data: any) {
    const formData: FormData = {
      firstname: '',
      email: '',
      phone: '',
    };

    if (Array.isArray(data)) {
      data.forEach((field: FormField) => {
        if (field.name === 'firstname') formData.firstname = field.value;
        if (field.name === 'email') formData.email = field.value;
        if (field.name === 'phone') formData.phone = field.value;
      });
    }

    console.log('Form submitted:', formData);

    // Dispatch custom event for calendly integration
    window.dispatchEvent(new CustomEvent('book-demo-form-submit', {
      detail: formData
    }));
  }

  // Initialize form when dialog opens
  const dialogWrapper = document.currentScript?.closest('.starwind-dialog');
  if (dialogWrapper) {
    const dialog = dialogWrapper.querySelector('dialog');
    if (dialog) {
      // Use MutationObserver to watch for dialog opening
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'open') {
            if ((mutation.target as HTMLDialogElement).open) {
              initializeHubSpotForm();
            }
          }
        });
      });

      observer.observe(dialog, { attributes: true });
    }
  }

  // Listen for form submission events
  window.addEventListener('hs-form-event', handleFormSubmission);
  window.addEventListener('message', handleFormSubmission);
</script>
