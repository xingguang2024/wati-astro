---
/**
 * Calendly Modal - Astro Component
 *
 * Uses starwind dialog for Calendly scheduling iframe
 */

import {
  Dialog,
  DialogContent
} from "@/components/starwind/dialog";

interface Props {
  id?: string;
}

const { id = "calendly-modal" } = Astro.props;
---

<Dialog id={id}>
  <DialogContent class="w-11/12 max-w-7xl h-[90vh] p-0" animationDuration={200}>
    <div class="h-full">
      <iframe
        id="calendly-iframe"
        class="w-full h-full border-0"
        frameBorder="0"
        title="Schedule a Demo">
      </iframe>
    </div>
  </DialogContent>
</Dialog>

<script>
  let currentUrl = '';

  // Set iframe URL when dialog opens
  const dialogWrapper = document.currentScript?.closest('.starwind-dialog');
  if (dialogWrapper) {
    const dialog = dialogWrapper.querySelector('dialog');
    const iframe = document.getElementById('calendly-iframe') as HTMLIFrameElement;

    if (dialog && iframe) {
      // Use MutationObserver to watch for dialog opening
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'open') {
            const isOpen = (mutation.target as HTMLDialogElement).open;

            if (isOpen && currentUrl) {
              iframe.src = currentUrl;
            } else if (!isOpen) {
              iframe.src = '';
            }
          }
        });
      });

      observer.observe(dialog, { attributes: true });

      // Listen for URL updates
      window.addEventListener('calendly:set-url', ((event: CustomEvent) => {
        currentUrl = event.detail;
        if (dialog.open && iframe) {
          iframe.src = currentUrl;
        }
      }) as EventListener);
    }
  }
</script>
