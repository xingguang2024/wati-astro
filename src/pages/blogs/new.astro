---
/**
 * Create New Blog Page
 *
 * Creates a new blog and redirects to the edit page.
 * This is a server-side redirect wrapper for blog creation.
 */

import { AuthService } from '@/lib/auth';
import { blogs } from '@/db/schema';
import { eq } from 'drizzle-orm';
import type { APIContext } from 'astro';

export const prerender = false;

export async function GET({ request, locals, redirect }: APIContext) {
  // Verify authentication
  const token = AuthService.extractToken(request);
  const payload = token ? await AuthService.verifyToken(token) : null;

  if (!payload) {
    return redirect('/login');
  }

  // Check if DB is available
  const db = (locals as any).db;
  if (!db) {
    return new Response('Database not available', { status: 500 });
  }

  try {
    // Create a new blog with default values
    const blogId = crypto.randomUUID();
    const now = Date.now();
    const defaultTitle = 'Untitled Blog';
    const baseSlug = defaultTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    let slug = baseSlug;
    let counter = 1;

    // Ensure unique slug
    while (true) {
      const existing = await db.select().from(blogs).where(eq(blogs.slug, slug)).limit(1);
      if (existing.length === 0) break;
      slug = `${baseSlug}-${counter++}`;
    }

    // Default content structure for Plate editor
    const defaultContent = [
      {
        type: 'h1',
        children: [{ text: defaultTitle }],
      },
      {
        type: 'p',
        children: [{ text: 'Start writing your content here...' }],
      },
    ];

    await db.insert(blogs).values({
      id: blogId,
      userId: payload.userId,
      title: defaultTitle,
      slug,
      content: JSON.stringify(defaultContent),
      excerpt: null,
      status: 'draft',
      tags: null,
      createdAt: now,
      updatedAt: now,
    });

    // Redirect to the edit page
    return redirect(`/blogs/${blogId}/edit`);
  } catch (error) {
    console.error('Error creating blog:', error);
    return new Response('Failed to create blog', { status: 500 });
  }
}
