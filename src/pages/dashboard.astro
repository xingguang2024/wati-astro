---
/**
 * Dashboard / Blog Management Page
 *
 * Displays a list of user's blogs with filtering and actions.
 * Fetches blogs from /api/blogs endpoint.
 */

import Layout from '../layouts/Layout.astro';

const title = 'My Blogs - Wati';
const description = 'Manage and edit your blogs';
---

<Layout title={title} description={description}>
  <div class="min-h-screen bg-zinc-50 pt-20">
    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-3xl font-bold text-zinc-900">My Blogs</h1>
          <p class="mt-2 text-zinc-600">Create and manage your content</p>
        </div>
        <button
          id="createBlogBtn"
          class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center gap-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
          </svg>
          New Blog
        </button>
      </div>

      <!-- Status Filter -->
      <div class="flex gap-2 mb-6">
        <button
          data-status="all"
          class="status-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-zinc-900 text-white"
        >
          All
        </button>
        <button
          data-status="draft"
          class="status-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-white text-zinc-700 hover:bg-zinc-100"
        >
          Drafts
        </button>
        <button
          data-status="published"
          class="status-filter-btn px-4 py-2 rounded-lg font-medium transition-colors bg-white text-zinc-700 hover:bg-zinc-100"
        >
          Published
        </button>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-4 text-zinc-600">Loading blogs...</p>
      </div>

      <!-- Error State -->
      <div id="errorState" class="hidden text-center py-12">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-zinc-900 mb-2">Failed to load blogs</h3>
        <p id="errorMessage" class="text-zinc-600 mb-4"></p>
        <button
          id="retryBtn"
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          Try Again
        </button>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden text-center py-12">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-zinc-100 mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-zinc-900 mb-2">No blogs yet</h3>
        <p class="text-zinc-600 mb-4">Create your first blog to get started</p>
        <button
          id="createFirstBlogBtn"
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          Create Blog
        </button>
      </div>

      <!-- Blogs List -->
      <div id="blogsList" class="hidden space-y-4">
        <!-- Blogs will be rendered here by JavaScript -->
      </div>
    </div>
  </div>
</Layout>

<script>
  interface Blog {
    id: string;
    title: string;
    slug: string;
    status: 'draft' | 'published' | 'archived';
    excerpt: string | null;
    updatedAt: number;
    createdAt: number;
  }

  interface BlogsResponse {
    blogs: Blog[];
  }

  // DOM elements
  const loadingState = document.getElementById('loadingState');
  const errorState = document.getElementById('errorState');
  const emptyState = document.getElementById('emptyState');
  const blogsList = document.getElementById('blogsList');
  const errorMessage = document.getElementById('errorMessage');
  const createBlogBtn = document.getElementById('createBlogBtn');
  const createFirstBlogBtn = document.getElementById('createFirstBlogBtn');
  const retryBtn = document.getElementById('retryBtn');
  const statusFilterBtns = document.querySelectorAll('.status-filter-btn');

  let currentStatus: string = 'all';

  // Format date
  function formatDate(timestamp: number): string {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) {
      return 'Today';
    } else if (diffDays === 1) {
      return 'Yesterday';
    } else if (diffDays < 7) {
      return `${diffDays} days ago`;
    } else {
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
  }

  // Get status badge class
  function getStatusClass(status: string): string {
    switch (status) {
      case 'published':
        return 'bg-green-100 text-green-800';
      case 'draft':
        return 'bg-yellow-100 text-yellow-800';
      case 'archived':
        return 'bg-zinc-100 text-zinc-800';
      default:
        return 'bg-zinc-100 text-zinc-800';
    }
  }

  // Render blogs
  function renderBlogs(blogs: Blog[]): void {
    if (blogs.length === 0) {
      emptyState?.classList.remove('hidden');
      blogsList?.classList.add('hidden');
      return;
    }

    emptyState?.classList.add('hidden');
    blogsList?.classList.remove('hidden');

    const html = blogs.map((blog) => `
      <div class="bg-white rounded-lg border border-zinc-200 p-6 hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-3 mb-2">
              <h3 class="text-lg font-semibold text-zinc-900 truncate">${escapeHtml(blog.title)}</h3>
              <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(blog.status)}">
                ${blog.status.charAt(0).toUpperCase() + blog.status.slice(1)}
              </span>
            </div>
            ${blog.excerpt ? `<p class="text-zinc-600 mb-3 line-clamp-2">${escapeHtml(blog.excerpt)}</p>` : ''}
            <p class="text-sm text-zinc-500">Last updated ${formatDate(blog.updatedAt)}</p>
          </div>
          <div class="flex items-center gap-2 ml-4">
            <a
              href="/blogs/${blog.id}/edit"
              class="px-4 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
            >
              Edit
            </a>
            <button
              data-id="${blog.id}"
              class="delete-blog-btn px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors"
            >
              Delete
            </button>
          </div>
        </div>
      </div>
    `).join('');

    if (blogsList) {
      blogsList.innerHTML = html;
    }

    // Add delete event listeners
    document.querySelectorAll('.delete-blog-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const blogId = (e.currentTarget as HTMLElement).dataset.id;
        if (!blogId) return;

        if (confirm('Are you sure you want to delete this blog?')) {
          await deleteBlog(blogId);
        }
      });
    });
  }

  // Escape HTML
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Fetch blogs
  async function fetchBlogs(status: string = 'all'): Promise<void> {
    // Show loading
    loadingState?.classList.remove('hidden');
    errorState?.classList.add('hidden');
    emptyState?.classList.add('hidden');
    blogsList?.classList.add('hidden');

    try {
      const url = status === 'all'
        ? '/api/blogs'
        : `/api/blogs?status=${status}`;

      const response = await fetch(url);

      if (!response.ok) {
        if (response.status === 401) {
          // Redirect to login if not authenticated
          window.location.href = '/login';
          return;
        }
        throw new Error('Failed to fetch blogs');
      }

      const data: BlogsResponse = await response.json();
      renderBlogs(data.blogs);
    } catch (error) {
      console.error('Error fetching blogs:', error);
      errorState?.classList.remove('hidden');
      if (errorMessage && error instanceof Error) {
        errorMessage.textContent = error.message;
      }
    } finally {
      loadingState?.classList.add('hidden');
    }
  }

  // Delete blog
  async function deleteBlog(blogId: string): Promise<void> {
    try {
      const response = await fetch(`/api/blogs/${blogId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Failed to delete blog');
      }

      // Refresh the list
      await fetchBlogs(currentStatus);
    } catch (error) {
      console.error('Error deleting blog:', error);
      alert('Failed to delete blog. Please try again.');
    }
  }

  // Create new blog
  function createNewBlog(): void {
    window.location.href = '/blogs/new';
  }

  // Status filter handlers
  statusFilterBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const status = btn.dataset.status || 'all';
      currentStatus = status;

      // Update button styles
      statusFilterBtns.forEach((b) => {
        if (b === btn) {
          b.classList.remove('bg-white', 'text-zinc-700', 'hover:bg-zinc-100');
          b.classList.add('bg-zinc-900', 'text-white');
        } else {
          b.classList.remove('bg-zinc-900', 'text-white');
          b.classList.add('bg-white', 'text-zinc-700', 'hover:bg-zinc-100');
        }
      });

      fetchBlogs(status);
    });
  });

  // Event listeners
  createBlogBtn?.addEventListener('click', createNewBlog);
  createFirstBlogBtn?.addEventListener('click', createNewBlog);
  retryBtn?.addEventListener('click', () => fetchBlogs(currentStatus));

  // Initial fetch
  fetchBlogs();
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
